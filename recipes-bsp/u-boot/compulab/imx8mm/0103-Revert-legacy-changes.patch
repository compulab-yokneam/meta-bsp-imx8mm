From acb6d173821f0b98a29aa7789a58c32ae67fc689 Mon Sep 17 00:00:00 2001
From: Valentin Raevsky <valentin@compulab.co.il>
Date: Tue, 14 Dec 2021 00:14:54 +0200
Subject: [PATCH 103/103] Revert legacy changes

Signed-off-by: Valentin Raevsky <valentin@compulab.co.il>
---
 arch/arm/lib/bootm.c                     |  2 -
 arch/arm/lib/cache-cp15.c                |  5 +--
 arch/arm/mach-imx/imx8m/soc.c            | 47 +++++++++++++++---------
 board/compulab/plat/imx8mm/board/board.c | 15 +-------
 4 files changed, 32 insertions(+), 37 deletions(-)

diff --git a/arch/arm/lib/bootm.c b/arch/arm/lib/bootm.c
index e4021e1025..b3988ae7e3 100644
--- a/arch/arm/lib/bootm.c
+++ b/arch/arm/lib/bootm.c
@@ -154,8 +154,6 @@ static void setup_memory_tags(struct bd_info *bd)
 	int i;
 
 	for (i = 0; i < CONFIG_NR_DRAM_BANKS; i++) {
-		if (!gd->bd->bi_dram[i].size)
-			continue;
 		params->hdr.tag = ATAG_MEM;
 		params->hdr.size = tag_size (tag_mem32);
 
diff --git a/arch/arm/lib/cache-cp15.c b/arch/arm/lib/cache-cp15.c
index f6a9108fb9..b6d966e319 100644
--- a/arch/arm/lib/cache-cp15.c
+++ b/arch/arm/lib/cache-cp15.c
@@ -116,11 +116,8 @@ __weak void dram_bank_mmu_setup(int bank)
 	for (i = bd->bi_dram[bank].start >> MMU_SECTION_SHIFT;
 	     i < (bd->bi_dram[bank].start >> MMU_SECTION_SHIFT) +
 		 (bd->bi_dram[bank].size >> MMU_SECTION_SHIFT);
-	     i++) {
-		if(!bd->bi_dram[bank].size)
-			continue;
+	     i++)
 		set_section_dcache(i, DCACHE_DEFAULT_OPTION);
-	}
 }
 
 /* to activate the MMU we need to set up virtual memory: use 1M areas */
diff --git a/arch/arm/mach-imx/imx8m/soc.c b/arch/arm/mach-imx/imx8m/soc.c
index 80d8cea198..ec706b9fcf 100644
--- a/arch/arm/mach-imx/imx8m/soc.c
+++ b/arch/arm/mach-imx/imx8m/soc.c
@@ -181,18 +181,32 @@ static unsigned int imx8m_find_dram_entry_in_mem_map(void)
 
 void enable_caches(void)
 {
-	int i = 0;
-	int entry = imx8m_find_dram_entry_in_mem_map();
-	u64 attrs = imx8m_mem_map[entry].attrs;
-
-	while (i < CONFIG_NR_DRAM_BANKS && entry < ARRAY_SIZE(imx8m_mem_map)) {
-		if (gd->bd->bi_dram[i].start == 0)
-			break;
-		imx8m_mem_map[entry].phys = gd->bd->bi_dram[i].start;
-		imx8m_mem_map[entry].virt = gd->bd->bi_dram[i].start;
-		imx8m_mem_map[entry].size = gd->bd->bi_dram[i].size;
-		imx8m_mem_map[entry].attrs = attrs;
-		i++; entry++;
+	/* If OPTEE runs, remove OPTEE memory from MMU table to avoid speculative prefetch */
+	if (rom_pointer[1]) {
+		/*
+		 * TEE are loaded, So the ddr bank structures
+		 * have been modified update mmu table accordingly
+		 */
+		int i = 0;
+		/*
+		 * please make sure that entry initial value matches
+		 * imx8m_mem_map for DRAM1
+		 */
+		int entry = imx8m_find_dram_entry_in_mem_map();
+		u64 attrs = imx8m_mem_map[entry].attrs;
+
+		while (i < CONFIG_NR_DRAM_BANKS &&
+		       entry < ARRAY_SIZE(imx8m_mem_map)) {
+			if (gd->bd->bi_dram[i].start == 0)
+				break;
+			imx8m_mem_map[entry].phys = gd->bd->bi_dram[i].start;
+			imx8m_mem_map[entry].virt = gd->bd->bi_dram[i].start;
+			imx8m_mem_map[entry].size = gd->bd->bi_dram[i].size;
+			imx8m_mem_map[entry].attrs = attrs;
+			debug("Added memory mapping (%d): %llx %llx\n", entry,
+			      imx8m_mem_map[entry].phys, imx8m_mem_map[entry].size);
+			i++; entry++;
+		}
 	}
 
 	icache_enable();
@@ -208,7 +222,7 @@ __weak int board_phys_sdram_size(phys_size_t *size)
 	return 0;
 }
 
-__weak int dram_init(void)
+int dram_init(void)
 {
 	unsigned int entry = imx8m_find_dram_entry_in_mem_map();
 	phys_size_t sdram_size;
@@ -233,7 +247,6 @@ __weak int dram_init(void)
 
 	return 0;
 }
-
 __weak int dram_init_banksize(void)
 {
 	int bank = 0;
@@ -245,7 +258,7 @@ __weak int dram_init_banksize(void)
 		return ret;
 
 	gd->bd->bi_dram[bank].start = PHYS_SDRAM;
-	if (0 /*rom_pointer[1]*/) {
+	if (rom_pointer[1]) {
 		phys_addr_t optee_start = (phys_addr_t)rom_pointer[0];
 		phys_size_t optee_size = (size_t)rom_pointer[1];
 
@@ -276,7 +289,7 @@ __weak int dram_init_banksize(void)
 	return 0;
 }
 
-__weak phys_size_t get_effective_memsize(void)
+phys_size_t get_effective_memsize(void)
 {
 	/* return the first bank as effective memory */
 	if (rom_pointer[1])
@@ -1396,7 +1409,7 @@ void do_error(struct pt_regs *pt_regs, unsigned int esr)
 #endif
 #endif
 
-#if defined(CONFIG_IMX8MN) || defined(CONFIG_IMX8MP)
+#if defined(CONFIG_IMX8MN) /*|| defined(CONFIG_IMX8MP)*/
 enum env_location env_get_location(enum env_operation op, int prio)
 {
 	enum boot_device dev = get_boot_device();
diff --git a/board/compulab/plat/imx8mm/board/board.c b/board/compulab/plat/imx8mm/board/board.c
index 3ce1659c61..e0d10a87f7 100644
--- a/board/compulab/plat/imx8mm/board/board.c
+++ b/board/compulab/plat/imx8mm/board/board.c
@@ -31,6 +31,7 @@
 #include <asm/mach-imx/video.h>
 #include <imx_sip.h>
 #include <linux/arm-smccc.h>
+#include <linux/delay.h>
 #include "ddr/ddr.h"
 #include "common/eeprom.h"
 #include "common/rtc.h"
@@ -75,20 +76,6 @@ ulong board_get_usable_ram_top(ulong total_size)
         return gd->ram_top;
 }
 
-int dram_init(void)
-{
-	phys_size_t sdram_size;
-	int ret;
-	ret = board_phys_sdram_size(&sdram_size);
-	if (ret)
-		return ret;
-
-	/* rom_pointer[1] contains the size of TEE occupies */
-	gd->ram_size = sdram_size - rom_pointer[1];
-
-	return 0;
-}
-
 #ifdef CONFIG_OF_BOARD_SETUP
 static void fdt_set_sn(void *blob)
 {
-- 
2.17.1

